<!DOCTYPE html>
<html>
<head>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="stylesheets/cs1010.css">
<link rel="stylesheet" type="text/css" href="stylesheets/light.css">
<title>CS1010 AY22/23 S1 Lab 7</title>
<meta charset="utf-8">
</head>
<body>
<textarea id="source">
class: middle, center

#### Lab 7
## Intro to Clang

### 13 October 2022

---

### How to Compile a Program?

- Currently, just run `make` or `make &lt;prog&gt;`

- CS1010 hides the details away with `Makefile`

- How to do it post-CS1010?

---
### Clang

- Two major compilers for C/C++: `gcc` and `clang`

- The ways to use them is similar

---
### Simplest Use Case

Create a program called `teh.c`

```C
int main()
{
}
```

---
### Simplest Use Case

Run
```
$ clang teh.c
```

`clang` creates an executable called `a.out` in your current directory.

---
### Naming the Executable

```
$ clang teh.c -o teh
```

Creates an executable called `teh` in your current directory.

---
### Caution

```
$ clang teh.c -o teh.c
```

Would override your code!

---
Change `teh.c` to:
```C
int main()
{
  main();
}
```

and run
```
$ clang teh.c
```

---

**Important**:  Clang does not give many warnings that have helped you by default.

Now run
```
$ clang -Wall teh.c
```

`-W` controls what warnings to turn on.  `all` turns on a set of common warnings (but NOT all).

---
Change `teh.c` to:
.small[
```C
int main()
{
  int *p; 
  *p = 1;
}
```
]

Run
.small[
```
$ clang -fsanitize=address teh.c
$ ./a.out
```
]
---
You should see
.tiny[
```
==1640230==ERROR: AddressSanitizer: SEGV on unknown address ...
==1640230==The signal is caused by a WRITE memory access.
==1640230==Hint: address points to the zero page.
    #0 0x4c3163 in main (/home/course/cs1010/a.out+0x4c3163)
	  :
```
]

The usual file name and line number are not shown.  We see `a.out+0x4c3163` instead

---
Now repeat with `-g` flag
.small[
```
$ clang -fsanitize=address -g teh.c
$ ./a.out
```
]
We get:
.small[
```
#0 0x4c3163 in main /home/course/cs1010/teh.c:4:6
```
]
---
### Debugging Information

- `-g` embeds extra information (such as function names, line numbers) into the executable.

- Compare the size of executable generated by `clang teh.c` and `clang -g teh.c`

---
Change `teh.c` to:
.small[
```C
#include &lt;math.h&gt;

int main()
{
  sqrt(4);
}
```
]

Run
.small[
```
$ clang teh.c
```
]

---
Now you see:

.tiny[
```
/usr/bin/ld: /tmp/a-fcfd33.o: in function `main':
teh.c:(.text+0x16): undefined reference to `sqrt'
clang: error: linker command failed with exit code 1 (use -v to see invocation)
```
]

The linker `ld` is a program that resolves external function calls.  


---
We need to tell `clang` that `sqrt` is defined in a file called `libm.a` somewhere in `/usr/lib`.

To do so, run:
```
$ clang teh.c -lm
```

`-lname` tells `clang` to look for missing function in a file `libname.a` under `/usr/lib`.

---
Change `teh.c` to:
.small[
```C
#include "cs1010.h"
int main()
{
  cs1010_print_string("hello");
}
```
]

Try:
```
$ clang teh.c
```

---
You should see:
.smaller[
```
teh.c:1:10: fatal error: 'cs1010.h' file not found
#include "cs1010.h"
         ^~~~~~~~~~
```
]

`cs1010.h` is not part of the standard library.  It is provided by CS1010 under `~cs1010/include`.

---
To tell `clang` where to find the header files, we use `-I` flag.

Try:
```
$ clang -I ~cs1010/include teh.c
```

---
You should see:
.tiny[
```
/usr/bin/ld: /tmp/teh-36731a.o: in function `main':
teh.c:(.text+0xf): undefined reference to `cs1010_print_string'
clang: error: linker command failed with exit code 1 (use -v to see invocation)
```
]

The function is defined in `libcs1010.a` under `~cs1010/lib`.

---
But

.small[
```
$ clang -I ~cs1010/include teh.c -lcs1010
```
]

does not work.  

Tell `clang` where to look for `libcs1010.a`
.smaller[
```
$ clang -I ~cs1010/include -L ~cs1010/lib teh.c -lcs1010
```
]

---
We can put all the compile flags into a file called `compile_flags.txt`, one flag per line.

.small[
```
-Wall
-g 
-I/home/course/cs1010/include
-L/home/course/cs1010/lib
```
]

and run
.small[
```
$ clang @compile_flags.txt teh.c -lcs1010
```
]

---
class: bottom

.tiny[
Version: 1.1

Last Updated:  Sun Sep  4 00:22:15 +08 2022
]
</textarea>

<script src="https://remarkjs.com/downloads/remark-latest.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
<script src="javascripts/counter.js">
</script>
<script>
remark.macros.scale = function (percentage) {
	var url = this;
	return '<img src="' + url + '" style="width: ' + percentage + '" />';
};
// ![:scale 50%](image.jpg)

var slideshow = remark.create({
    navigation: {
	    scroll: false
	},
	ratio: '16:9',
	highlightStyle: 'tomorrow',
    slideNumberFormat: 'AY2223 S1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%current%',
});
 // Setup MathJax
  MathJax.Hub.Config({
	  tex2jax: {
		inlineMath: [['$', '$']],
		// inlineMath: [['$', '$'], ['\\(', '\\)']],
		displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		skipTags: ['script', 'noscript', 'style', 'pre']
	  }
  });

  MathJax.Hub.Configured();
</script>
</body>
</html>
